#!/usr/bin/env bash
set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

pipelines_pre_build() {
  local DEFAULT_IMAGE=$(pipelines_get_config ".image")

  if [[ -z "${DEFAULT_IMAGE}" || "${DEFAULT_IMAGE}" = "null" ]]; then
    DEFAULT_IMAGE="ubuntu"
  fi

  echo "default_image: ${DEFAULT_IMAGE}"

  STEPS_COUNT=$(pipelines_get_config ".pipelines.default|length")

  echo "steps count: ${STEPS_COUNT}"

  local STEP_NO
  for (( i=0; i<$STEPS_COUNT; i++ ));
  do
    STEP_NO=$i
    echo "prepare step no: $STEP_NO"
    pipelines_prepare_step $DEFAULT_IMAGE $STEP_NO
  done
}

pipelines_prepare_step() {
  local DEFAULT_IMAGE="$1" STEP_NO="$2"
  local IMAGE=$(pipelines_get_config ".pipelines.default[${STEP_NO}].step.image")
  local TMP_DIR=$(mktemp -d)
  local SCRIPT_LIST=$(pipelines_get_config ".pipelines.default[${STEP_NO}].step.script[]")
  local TMPFILE="${TMP_DIR}/step_${STEP_NO}.sh"

  if [[ -z "$IMAGE" || "$IMAGE" = "null" ]]; then
    IMAGE=$DEFAULT_IMAGE
  fi

  echo "using image: ${IMAGE} ; for step no: ${STEP_NO}"

  if [[ $DOKKU_TRACE ]]; then
    local SET_X_FLAG=" set -x"
  fi

  cat > "$TMPFILE" <<EOF
#!/usr/bin/env bash
set -e; set -o pipefail;$SET_X_FLAG

cd /app
EOF

  # @see https://unix.stackexchange.com/a/164548/179662
  TMPIFS=$IFS
  IFS=
  echo "$SCRIPT_LIST" >> "$TMPFILE"
  IFS=$TMPIFS

  chmod +x "$TMPFILE"

  pipelines_run_step $TMP_DIR $IMAGE $STEP_NO
}

pipelines_run_step() {
  local TMP_DIR="$1" IMAGE="$2" STEP_NO="$3"

  docker run --rm --interactive \
    --volume ${TMP_DIR}:/dokku-pipelines \
    --volume $PWD:/app \
    --user $(id -u):$(id -g) \
    ${IMAGE} /dokku-pipelines/step_${STEP_NO}.sh
}

pipelines_get_config() {
  local PIPELINES_FILE="dokku-pipelines.yml"
  cat ${PIPELINES_FILE} | docker run -i --rm evns/yq -r "$1"
}

